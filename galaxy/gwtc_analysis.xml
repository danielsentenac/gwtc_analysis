<?xml version="1.0" encoding="UTF-8"?>
<tool id="gwtc_analysis" name="GWTC analysis" version="0.1.9" profile="22.05">
  <description>Catalog statistics, event selection, skymap search, parameter estimation</description>
  <requirements>
    <container type="docker">docker.io/danielsentenac/gwtc-tool:0.2.3</container>
  </requirements>
   <command detect_errors="exit_code"><![CDATA[
#set $cmd = "python -m gwtc_analysis.cli"
#if str($mode.analysis_mode) == "catalog_statistics":
    #set $cmd = $cmd + " catalog_statistics"
    #set $cmd = $cmd + " --catalogs"
    #for $c in $mode.catalogs:
        #set $cmd = $cmd + " '" + str($c) + "'"
    #end for
    #set $cmd = $cmd + " --out-events '" + str($out_events) + "'"
    #set $cmd = $cmd + " --out-report '" + str($out_report) + "'"
    #if $mode.include_detectors:
        #set $cmd = $cmd + " --include-detectors"
    #end if
    #if $mode.include_area:
        #set $cmd = $cmd + " --include-area"
        #set $cmd = $cmd + " --area-cred '" + str($mode.area_cred) + "'"
    #end if
    #set $cmd = $cmd + " --plots-dir '" + str($mode.plots_dir) + "'"
    #set $cmd = $cmd + " --data-repo '" + str($mode.data_repo) + "'"
    $cmd && : > '$out_selection'

#elif str($mode.analysis_mode) == "event_selection":
    #set $cmd = $cmd + " event_selection"
    #set $cmd = $cmd + " --catalogs"
    #for $c in $mode.catalogs:
        #set $cmd = $cmd + " '" + str($c) + "'"
    #end for
    #set $cmd = $cmd + " --out-selection '" + str($out_selection) + "'"
    #if $mode.m1_min:
        #set $cmd = $cmd + " --m1-min '" + str($mode.m1_min) + "'"
    #end if
    #if $mode.m1_max:
        #set $cmd = $cmd + " --m1-max '" + str($mode.m1_max) + "'"
    #end if
    #if $mode.m2_min:
        #set $cmd = $cmd + " --m2-min '" + str($mode.m2_min) + "'"
    #end if
    #if $mode.m2_max:
        #set $cmd = $cmd + " --m2-max '" + str($mode.m2_max) + "'"
    #end if
    #if $mode.dl_min:
        #set $cmd = $cmd + " --dl-min '" + str($mode.dl_min) + "'"
    #end if
    #if $mode.dl_max:
        #set $cmd = $cmd + " --dl-max '" + str($mode.dl_max) + "'"
    #end if
    $cmd && : > '$out_events' && : > '$out_report'

#elif str($mode.analysis_mode) == "search_skymaps":
    #set $cmd = $cmd + " search_skymaps"
    #set $cmd = $cmd + " --catalogs"
    #for $c in $mode.catalogs:
        #set $cmd = $cmd + " '" + str($c) + "'"
    #end for
    #set $cmd = $cmd + " --ra-deg '" + str($mode.ra_deg) + "'"
    #set $cmd = $cmd + " --dec-deg '" + str($mode.dec_deg) + "'"
    #set $cmd = $cmd + " --prob '" + str($mode.prob) + "'"
    #set $cmd = $cmd + " --waveform '" + str($mode.waveform) + "'"
    #set $cmd = $cmd + " --out-events '" + str($out_events) + "'"
    #set $cmd = $cmd + " --out-report '" + str($out_report) + "'"
    #set $cmd = $cmd + " --plots-dir '" + str($mode.plots_dir) + "'"
    #set $cmd = $cmd + " --data-repo '" + str($mode.data_repo) + "'"
    $cmd && : > '$out_selection'

#elif str($mode.analysis_mode) == "parameters_estimation":
    #set $cmd = $cmd + " parameters_estimation"
    #set $cmd = $cmd + " --src-name '" + str($mode.src_name) + "'"
    #set $cmd = $cmd + " --out-report '" + str($out_report) + "'"
    #set $cmd = $cmd + " --plots-dir '" + str($mode.plots_dir) + "'"
    #set $cmd = $cmd + " --data-repo '" + str($mode.data_repo) + "'"

    #if $mode.pe_vars:
        #set $cmd = $cmd + " --pe-vars"
        #for $v in $mode.pe_vars:
            #set $cmd = $cmd + " '" + str($v) + "'"
        #end for
    #end if

    #if $mode.pe_pairs:
        #set $cmd = $cmd + " --pe-pairs"
        #for $p in $mode.pe_pairs:
            #set $cmd = $cmd + " '" + str($p) + "'"
        #end for
    #end if

    #set $cmd = $cmd + " --start '" + str($mode.start) + "'"
    #set $cmd = $cmd + " --stop '" + str($mode.stop) + "'"
    #set $cmd = $cmd + " --fs-low '" + str($mode.fs_low) + "'"
    #set $cmd = $cmd + " --fs-high '" + str($mode.fs_high) + "'"
    #set $cmd = $cmd + " --sample-method '" + str($mode.sample_method) + "'"
    #set $cmd = $cmd + " --strain-approximant '" + str($mode.strain_approximant) + "'"

    $cmd && : > '$out_events' && : > '$out_selection'
#end if
]]></command>

  <inputs>
    <conditional name="mode">
      <param name="analysis_mode" type="select" label="Analysis mode">
        <option value="catalog_statistics" selected="true">Catalog statistics</option>
        <option value="event_selection">Event selection</option>
        <option value="search_skymaps">Search skymaps at RA/Dec</option>
        <option value="parameters_estimation">Parameter estimation (PE)</option>
      </param>

      <when value="catalog_statistics">
        <param name="catalogs" type="select" label="Catalogs" multiple="true" display="checkboxes">
          <option value="ALL">ALL</option>
          <option value="GWTC-1">GWTC-1</option>
          <option value="GWTC-2.1" selected="true">GWTC-2.1</option>
          <option value="GWTC-3">GWTC-3</option>
          <option value="GWTC-4">GWTC-4</option>
        </param>
        <param name="include_detectors" type="boolean" label="Include detector network" truevalue="true" falsevalue="false" checked="false"/>
        <param name="include_area" type="boolean" label="Compute localization area (Axx)" truevalue="true" falsevalue="false" checked="false"/>
        <param name="area_cred" type="float" label="Credible level for area" value="0.9"/>
        <param name="plots_dir" type="text" label="Plots directory" value="cat_plots"/>
        <param name="data_repo" type="select" label="Data repository" help="Where to read data from">
          <option value="zenodo" selected="true">zenodo</option>
          <option value="s3">s3</option>
          <option value="galaxy">galaxy</option>
        </param>
      </when>

      <when value="event_selection">
        <param name="catalogs" type="select" label="Catalogs" multiple="true" display="checkboxes">
          <option value="ALL">ALL</option>
          <option value="GWTC-1">GWTC-1</option>
          <option value="GWTC-2.1" selected="true">GWTC-2.1</option>
          <option value="GWTC-3">GWTC-3</option>
          <option value="GWTC-4">GWTC-4</option>
        </param>
        <param name="m1_min" type="float" optional="true" label="m1 (source) min [Msun]" />
        <param name="m1_max" type="float" optional="true" label="m1 (source) max [Msun]" />
        <param name="m2_min" type="float" optional="true" label="m2 (source) min [Msun]" />
        <param name="m2_max" type="float" optional="true" label="m2 (source) max [Msun]" />
        <param name="dl_min" type="float" optional="true" label="Luminosity distance min [Mpc]" />
        <param name="dl_max" type="float" optional="true" label="Luminosity distance max [Mpc]" />
      </when>

      <when value="search_skymaps">
        <param name="catalogs" type="select" label="Catalogs" multiple="true" display="checkboxes">
          <option value="ALL">ALL</option>
          <option value="GWTC-1">GWTC-1</option>
          <option value="GWTC-2.1" selected="true">GWTC-2.1</option>
          <option value="GWTC-3">GWTC-3</option>
          <option value="GWTC-4">GWTC-4</option>
        </param>
        <param name="ra_deg" type="float" value="30.0" label="Right ascension (deg)"/>
        <param name="dec_deg" type="float" value="40.0" label="Declination (deg)"/>
        <param name="prob" type="float" value="0.9" min="0.01" max="1.0" label="Credible-level threshold"/>
        <param name="waveform" type="text" value="Mixed" label="Waveform filter" help="Select skymap products; use 'any' to disable filtering."/>
        <param name="plots_dir" type="text" label="Plots directory" value="sky_plots"/>
        <param name="data_repo" type="select" label="Data repository">
          <option value="zenodo" selected="true">zenodo</option>
          <option value="s3">s3</option>
          <option value="galaxy">galaxy</option>
        </param>
      </when>

      <when value="parameters_estimation">
        <param name="src_name" type="text" label="Source event name" value="GW150914"/>
        <param name="plots_dir" type="text" label="Plots directory" value="pe_plots"/>
        <param name="data_repo" type="select" label="Data repository">
          <option value="zenodo" selected="true">zenodo</option>
          <option value="s3">s3</option>
          <option value="galaxy">galaxy</option>
        </param>
        <param name="pe_vars" type="text" optional="true" multiple="true" label="PE variables to plot (1D)" help="Space-separated; if empty defaults are used."/>
        <param name="pe_pairs" type="text" optional="true" multiple="true" label="PE variable pairs to plot (2D)" help="Space-separated items like x:y (e.g. chi_eff:chi_p)."/>
        <param name="start" type="float" label="Seconds before GPS time" value="0.2"/>
        <param name="stop" type="float" label="Seconds after GPS time" value="0.1"/>
        <param name="fs_low" type="float" label="Bandpass low frequency (Hz)" value="20.0"/>
        <param name="fs_high" type="float" label="Bandpass high frequency (Hz)" value="300.0"/>
        <param name="sample_method" type="text" label="Sample method / label selector" value="Mixed"/>
        <param name="strain_approximant" type="text" label="Strain approximant" value="IMRPhenomXPHM"/>
      </when>
    </conditional>
  </inputs>

  <outputs>
    <data name="out_events" format="tabular" label="${tool.name} on ${on_string}: events"/>
    <data name="out_selection" format="tabular" label="${tool.name} on ${on_string}: selection"/>
    <data name="out_report" format="html" label="${tool.name} on ${on_string}: report"/>
  </outputs>

  <tests>
    <test expect_exit_code="0">
      <param name="mode|analysis_mode" value="catalog_statistics"/>
      <param name="mode|catalogs" value="GWTC-2.1"/>
      <param name="mode|include_detectors" value="false"/>
      <param name="mode|include_area" value="false"/>
      <param name="mode|data_repo" value="zenodo"/>
      <param name="mode|plots_dir" value="cat_plots"/>
      <output name="out_events">
        <assert_contents>
          <has_text text="event_id"/>
          <has_n_lines min="2"/>
        </assert_contents>
      </output>
      <output name="out_report">
        <assert_contents>
          <has_text text="GWTC"/>
        </assert_contents>
      </output>
    </test>

    <test expect_exit_code="0">
      <param name="mode|analysis_mode" value="event_selection"/>
      <param name="mode|catalogs" value="GWTC-2.1"/>
      <param name="mode|m1_min" value="10"/>
      <param name="mode|m1_max" value="500"/>
      <output name="out_selection">
        <assert_contents>
          <has_text text="event_id"/>
          <has_n_lines min="2"/>
        </assert_contents>
      </output>
    </test>
  
    <test expect_exit_code="0">
      <param name="mode|analysis_mode" value="search_skymaps"/>
      <param name="mode|catalogs" value="GWTC-2.1"/>
      <param name="mode|ra_deg" value="180.0"/>
      <param name="mode|dec_deg" value="0.0"/>
      <param name="mode|prob" value="0.9"/>
      <param name="mode|waveform" value="Mixed"/>
      <param name="mode|data_repo" value="zenodo"/>
      <param name="mode|plots_dir" value="sky_plots"/>
      <output name="out_events">
        <assert_contents>
          <has_text text="event_id"/>
          <has_n_lines min="2"/>
        </assert_contents>
      </output>
      <output name="out_report">
        <assert_contents>
          <has_text text="skymap"/>
        </assert_contents>
      </output>
    </test>

    <test expect_exit_code="0">
      <param name="mode|analysis_mode" value="parameters_estimation"/>
      <param name="mode|src_name" value="GW150914_095045"/>
      <param name="mode|data_repo" value="zenodo"/>
      <param name="mode|plots_dir" value="pe_plots"/>
      <param name="mode|sample_method" value="Mixed"/>
      <param name="mode|strain_approximant" value="IMRPhenomXPHM"/>
      <output name="out_report">
        <assert_contents>
          <has_text text="Parameter estimation"/>
          <has_text text="Run parameters"/>
        </assert_contents>
      </output>
    </test>

  </tests>

  <help><![CDATA[
This tool wraps **gwtc_analysis**.

- **catalog_statistics**: fetch catalog(s) and produce a TSV + HTML report.
- **event_selection**: filter events by masses and luminosity distance and produce a TSV report.
- **search_skymaps**: check if a sky position is inside events' credible regions and produce a HTML report.
- **parameters_estimation**: generate PE posterior plots and strain vs waveform, and produce a HTML report.

Outputs are written to default filenames/dirs unless overridden.
  ]]></help>

  <citations>
    <citation type="bibtex">@misc{gwosc, title={GWOSC Event API}}</citation>
    <citation type="bibtex">@misc{pesummary, title={PESummary}}</citation>
    <citation type="bibtex">@misc{GWpy, title={GWpy}}</citation>
    <citation type="bibtex">@misc{ligo.skymap, title={ligo.skymap}}</citation>
  </citations>
</tool>
