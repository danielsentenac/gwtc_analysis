<tool id="gwtc_analysis" name="GWTC analysis" version="0.2.2" profile="22.05">
  <description>GWTC analysis (catalog statistics + event selection + skymap search)</description>
  <requirements>
     <container type="docker">docker.io/danielsentenac/gwtc-tool:0.1.4</container>
  </requirements>
  <command detect_errors="exit_code"><![CDATA[
    mkdir -p "\$(dirname '$out_events')" "\$(dirname '$out_report')" "\$(dirname '$out_selection')" &&
    
    PYTHONPATH='$__tool_directory__/..' python -m gwtc_analysis.cli \
        --mode '$mode.mode' \
        
        #if str($mode.mode) != "parameters_estimation":
            --catalogs ${' '.join($mode.catalogs)}
        #end if

        #if $mode.events_json:
            --events-json '$mode.events_json'
        #end if

        #if str($mode.mode) == "catalog_statistics":
            --out-events '$out_events'
            --out-report '$out_report'

            #if $mode.include_detectors:
                --include-detectors
            #end if

            #if $mode.include_area:
                --include-area
                --area-cred '$mode.area_cred'
            #end if

            #if $mode.skymaps_gwtc21:
                --skymaps-gwtc21 ${' '.join($mode.skymaps_gwtc21)}
            #end if
            #if $mode.skymaps_gwtc3:
                --skymaps-gwtc3 ${' '.join($mode.skymaps_gwtc3)}
            #end if
            #if $mode.skymaps_gwtc4:
                --skymaps-gwtc4 ${' '.join($mode.skymaps_gwtc4)}
            #end if

        #else if str($mode.mode) == "event_selection":
            --out-selection '$out_selection'

            #if $mode.m1_min and str($mode.m1_min).strip():
                --m1-min '$mode.m1_min'
            #end if
            #if $mode.m1_max and str($mode.m1_max).strip():
                --m1-max '$mode.m1_max'
            #end if
            #if $mode.m2_min and str($mode.m2_min).strip():
                --m2-min '$mode.m2_min'
            #end if
            #if $mode.m2_max and str($mode.m2_max).strip():
                --m2-max '$mode.m2_max'
            #end if
            #if $mode.dl_min and str($mode.dl_min).strip():
                --dl-min '$mode.dl_min'
            #end if
            #if $mode.dl_max and str($mode.dl_max).strip():
                --dl-max '$mode.dl_max'
            #end if
            
        #else if str($mode.mode) == "search_skymaps":
            --out-events '$out_events'
            --out-report '$out_report'
            --ra-deg  '$mode.ra_deg'
            --dec-deg '$mode.dec_deg'
            --prob '$mode.prob'
            
            #if $mode.events_json:
                --events-json '$mode.events_json'
            #end if
            #if $mode.skymaps:
                --skymaps #echo ' '.join([str($s) for $s in $mode.skymaps])
            #end if
            
        #else if str($mode.mode) == "parameters_estimation":
            --out-events '$out_events'
            --out-report '$out_report'
            --src-name '$mode.src_name'
            --sample-method '$mode.sample_method'
            --strain-approximant '$mode.strain_approximant'
            --fs-low '$mode.fs_low'
            --fs-high '$mode.fs_high'
            --start '$mode.start'
            --stop '$mode.stop'

		#end if
]]></command>


  <inputs>
    <conditional name="mode">
      <param name="mode" type="select" label="Analysis mode">
        <option value="catalog_statistics" selected="true">Catalog statistics</option>
        <option value="event_selection">Event selection</option>
        <option value="search_skymaps">Search skymaps at RA/Dec</option>
        <option value="parameters_estimation">Parameter estimation (PE)</option>
      </param>

      <when value="catalog_statistics">
        <param name="catalogs" type="select" label="Catalogs" multiple="true" display="checkboxes">
          <option value="GWTC-2.1-confident" selected="true">GWTC-2.1-confident</option>
          <option value="GWTC-3-confident" selected="true">GWTC-3-confident</option>
          <option value="GWTC-4.0">GWTC-4.0</option>
        </param>

        <param name="events_json" type="data" format="json" optional="true"
               label="Events JSON (offline mode)"/>

        <param name="include_detectors" type="boolean" label="Add detector network (GWOSC v2 calls)" checked="true" />
        <param name="include_area" type="boolean" label="Compute A90 from skymaps collections (optional)" checked="false" />
        <param name="area_cred" type="float" label="Credible level for A90" value="0.9" min="0.5" max="0.99" />

        <param name="skymaps_gwtc21" type="data_collection" collection_type="list" optional="true"
               label="Skymaps collection for GWTC-2.1-confident"/>
        <param name="skymaps_gwtc3" type="data_collection" collection_type="list" optional="true"
               label="Skymaps collection for GWTC-3-confident"/>
        <param name="skymaps_gwtc4" type="data_collection" collection_type="list" optional="true"
               label="Skymaps collection for GWTC-4.0"/>
      </when>

      <when value="event_selection">
        <param name="catalogs" type="select" label="Catalogs" multiple="true" display="checkboxes">
          <option value="GWTC-2.1-confident" selected="true">GWTC-2.1-confident</option>
          <option value="GWTC-3-confident" selected="true">GWTC-3-confident</option>
          <option value="GWTC-4.0">GWTC-4.0</option>
        </param>

        <param name="events_json" type="data" format="json" optional="true"
               label="Events JSON (offline mode)" />

        <param name="m1_min" type="float" optional="true" label="m1 (source) min [Msun]" />
        <param name="m1_max" type="float" optional="true" label="m1 (source) max [Msun]" />
        <param name="m2_min" type="float" optional="true" label="m2 (source) min [Msun]" />
        <param name="m2_max" type="float" optional="true" label="m2 (source) max [Msun]" />
        <param name="dl_min" type="float" optional="true" label="Luminosity distance min [Mpc]" />
        <param name="dl_max" type="float" optional="true" label="Luminosity distance max [Mpc]" />
      </when>
      
      <when value="search_skymaps">
        <param name="catalogs" type="select" label="Catalogs" multiple="true" display="checkboxes">
          <option value="GWTC-2.1-confident" selected="true">GWTC-2.1-confident</option>
          <option value="GWTC-3-confident">GWTC-3-confident</option>
          <option value="GWTC-4.0">GWTC-4.0</option>
        </param>

        <param name="events_json" type="data" format="json" optional="true" label="Events JSON (offline mode)"/>
        <param name="ra_deg"  type="float" value="30.0" label="Right ascension (deg)"/>
        <param name="dec_deg" type="float" value="40.0" label="Declination (deg)"/>
        <param name="prob"    type="float" value="0.5" min="0.01" max="1.0" label="Credible-level threshold"/>
        <param name="make_plots" type="select" label="Generate skymap plots">
          <option value="none">None</option>
          <option value="hits" selected="true">Hits only</option>
          <option value="all">All</option>
        </param>

        <!-- Galaxy collection input (list of FITS files) -->
        <param name="skymaps" type="data" format="fits,txt" multiple="true" optional="false" label="Skymap files (FITS or FITS.gz)"/>
      </when>
      <when value="parameters_estimation">

          <param name="src_name" type="text" label="Source event name" value="GW150914"/>

          <param name="sample_method" type="text" label="sample_method" value="IMRPhenomXPHM"/>
          <param name="strain_approximant" type="text" label="strain_approximant" value="IMRPhenomXPHM"/>

          <param name="start" type="float" label="Start (s)" value="0.2"/>
          <param name="stop" type="float" label="Stop (s)" value="0.05"/>
          <param name="fs_low" type="float" label="Bandpass low (Hz)" value="20.0"/>
          <param name="fs_high" type="float" label="Bandpass high (Hz)" value="300.0"/>

          <param name="events_json" type="data" format="json" optional="true" label="Events JSON (offline mode)"/>
      </when>

    </conditional>
  </inputs>
  <outputs>
    <data name="out_events" format="tabular" label="GWTC output table (TSV)">
      <filter>mode.get("analysis_mode") in ("catalog_statistics", "search_skymaps", "parameters_estimation")</filter>
    </data>

    <data name="out_report" format="html" label="GWTC catalog report">
      <filter>mode.get("analysis_mode") in ("catalog_statistics", "search_skymaps", "parameters_estimation")</filter>
    </data>

    <data name="out_selection" format="tabular" label="Selected events (TSV)">
      <filter>mode.get("analysis_mode") == "event_selection"</filter>
    </data>
  </outputs>
  <tests>
    <test expect_num_outputs="2">
      <param name="mode|analysis_mode" value="catalog_statistics"/>
      <param name="mode|catalogs" value="GWTC-2.1-confident"/>
      <param name="mode|include_detectors" value="false"/>
      <param name="mode|include_area" value="false"/>
      <param name="mode|events_json" value="gwtc_small.json"/>

      <output name="out_events" ftype="tabular">
        <assert_contents>
          <has_text text="event"/>
          <has_n_lines min="1"/>
        </assert_contents>
      </output>

      <output name="out_report" ftype="html">
        <assert_contents>
          <has_text text="GWTC"/>
        </assert_contents>
      </output>
    </test>

    <test expect_num_outputs="1">
      <param name="mode|analysis_mode" value="event_selection"/>
      <param name="mode|catalogs" value="GWTC-2.1-confident"/>
      <param name="mode|events_json" value="gwtc_small.json"/>
      <param name="mode|m1_min" value="10"/>
      <param name="mode|m1_max" value="500"/>

      <output name="out_selection" ftype="tabular">
        <assert_contents>
          <has_text text="event"/>
          <has_n_lines min="1"/>
        </assert_contents>
      </output>
    </test>
  </tests>
  <help><![CDATA[
... keep your help unchanged ...
]]></help>

  <citations>
    <citation type="bibtex">
@misc{gwosc,
  title        = {Gravitational Wave Open Science Center (GWOSC)},
  howpublished = {\url{https://gwosc.org}},
  note         = {Used via the GWOSC Event API}
}
    </citation>
    <citation type="bibtex">
@software{ligo_skymap,
  title  = {ligo.skymap},
  author = {Singer, Leo P. and others},
  url    = {https://lscsoft.docs.ligo.org/ligo.skymap/}
}
    </citation>
  </citations>
</tool>

